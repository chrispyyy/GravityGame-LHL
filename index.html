<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>Babylon - Getting Started</title>
    <script src="http://cdn.babylonjs.com/2-2/babylon.max.js"></script>
    <script src="game_object.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        #renderCanvas {
            width   : 100%;
            height  : 100%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
      window.addEventListener('DOMContentLoaded', function(){
        // get the canvas DOM element
        var canvas = document.getElementById('renderCanvas');

        // load the 3D engine
        var engine = new BABYLON.Engine(canvas, true);

        // createScene function that creates and return the scene
        var createScene = function()
        {
          // This creates a basic Babylon Scene object (non-mesh)
          var scene = new BABYLON.Scene(engine);

          // This creates and positions a free camera (non-mesh)
          var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 75, -0.0000000000000001), scene);

          // This targets the camera to scene origin
          camera.setTarget(BABYLON.Vector3.Zero());

          // This attaches the camera to the canvas
          camera.attachControl(canvas, true);

          // This creates a light, aiming 0,1,0 - to the sky (non-mesh)
          var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 5, 0), scene);
          
          // Default intensity is 1. Let's dim the light a small amount
          light.intensity = 0.7;

          var ground = BABYLON.Mesh.CreateGround("ground", 1000, 1000, 1, scene, false);
          var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
          groundMaterial.specularColor = BABYLON.Color3.Blue  ();
          ground.material = groundMaterial;
          ground.actionManager = new BABYLON.ActionManager(scene);

          var asteroids = [];

          var ship = new GameObject('ship', 1, .1, scene, -20, 1, -20);
          var canvasObjects = [];
          for (var i=0; i<2; i++) {
            canvasObjects[i] = new GameObject('planet', 6, 30, scene, 30- Math.random() * 60, 1,30 - Math.random()*60);
          }

          var isMouseDown = false;
          var eventStarted = null;
          var newBlackhole  = null;
          scene.onPointerDown = function (event, pickResult)
          {
            isMouseDown = true;
            eventStarted = Date.now()

            if (pickResult.hit) {
              var xCoord = pickResult.pickedPoint.x;
              var zCoord = pickResult.pickedPoint.z;
              newBlackhole = new GameObject('canvasObject', 1, 5, scene, xCoord, 1, zCoord);
              window.newBlackhole = newBlackhole;
              // canvasObjects.push(newThing);
              // console.log(canvasObjects);
            }
          };

          scene.onPointerUp = function(event)
          {
            isMouseDown = false;
            canvasObjects.push(newBlackhole);
            newBlackhole = null;
          }

          scene.registerBeforeRender(function()
          {  
            var forces = new BABYLON.Vector3(0, 0, 0);
            canvasObjects.forEach(function(canvasObject){
              forces = forces.add(ship.calculateForce(canvasObject));
            });
            ship.position.addInPlace(forces);
            if(isMouseDown)
            {
              if(newBlackhole)
              {
                var delta = Date.now() - eventStarted;
                console.log(delta);
                newBlackhole.canvasObject.scaling.addInPlace(new BABYLON.Vector3(.1,.1,.1));
                newBlackhole.mass = newBlackhole.mass + (delta/1000);
                console.log(newBlackhole.mass);
              }
            }
          });
          return scene;
        }

        // call the createScene function
        var scene = createScene();

        // run the render loop
        engine.runRenderLoop(function(){
          scene.render();
        });

      // the canvas/window resize event handler
      window.addEventListener('resize', function(){
        engine.resize();
      });
    });
  </script>
</body>
</html>